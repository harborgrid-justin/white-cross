{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///F:/temp/white-cross/frontend/src/lib/monitoring/sentry.ts"],"sourcesContent":["/**\r\n * Sentry Error Tracking and Performance Monitoring (Lazy Loaded)\r\n *\r\n * Provides comprehensive error tracking, performance monitoring,\r\n * and session replay for production environments.\r\n *\r\n * PERFORMANCE OPTIMIZATION: Lazy loads Sentry SDK to reduce initial bundle size by ~150KB (gzipped)\r\n */\r\n\r\nimport type * as SentryTypes from '@sentry/nextjs';\r\n\r\n// Track initialization state\r\nlet sentryInitialized = false;\r\nlet sentryInitPromise: Promise<typeof SentryTypes> | null = null;\r\n\r\n/**\r\n * Lazy load Sentry SDK\r\n * Only loads in production to minimize bundle size\r\n */\r\nasync function loadSentry(): Promise<typeof SentryTypes | null> {\r\n  // Skip in development to save bundle size\r\n  if (process.env.NODE_ENV !== 'production') {\r\n    return null;\r\n  }\r\n\r\n  // Return existing promise if already loading\r\n  if (sentryInitPromise) {\r\n    return sentryInitPromise;\r\n  }\r\n\r\n  // Load Sentry dynamically\r\n  sentryInitPromise = import('@sentry/nextjs');\r\n  return sentryInitPromise;\r\n}\r\n\r\n/**\r\n * Initialize Sentry for Next.js (Lazy Loaded)\r\n * Should be called after initial page load to improve performance\r\n */\r\nexport async function initSentry() {\r\n  if (sentryInitialized) {\r\n    return;\r\n  }\r\n\r\n  const SENTRY_DSN = process.env.NEXT_PUBLIC_SENTRY_DSN || process.env.SENTRY_DSN;\r\n  const environment = process.env.NEXT_PUBLIC_ENVIRONMENT || process.env.NODE_ENV;\r\n\r\n  if (!SENTRY_DSN) {\r\n    console.warn('Sentry DSN not configured, error tracking disabled');\r\n    return;\r\n  }\r\n\r\n  // Lazy load Sentry\r\n  const Sentry = await loadSentry();\r\n  if (!Sentry) {\r\n    return;\r\n  }\r\n\r\n  Sentry.init({\r\n    dsn: SENTRY_DSN,\r\n    environment,\r\n\r\n    // Performance Monitoring\r\n    tracesSampleRate: environment === 'production' ? 0.1 : 1.0,\r\n    profilesSampleRate: environment === 'production' ? 0.1 : 1.0,\r\n\r\n    // Session Replay\r\n    replaysSessionSampleRate: environment === 'production' ? 0.1 : 1.0,\r\n    replaysOnErrorSampleRate: 1.0,\r\n\r\n    // Error filtering\r\n    beforeSend(event, hint) {\r\n      // Filter out non-critical errors in production\r\n      if (environment === 'production') {\r\n        // Don't send browser extension errors\r\n        if (event.exception?.values?.[0]?.value?.includes('extension://')) {\r\n          return null;\r\n        }\r\n\r\n        // Don't send canceled requests\r\n        if (event.exception?.values?.[0]?.type === 'AbortError') {\r\n          return null;\r\n        }\r\n      }\r\n\r\n      // Sanitize PHI from error messages (HIPAA compliance)\r\n      if (event.message) {\r\n        event.message = sanitizePHI(event.message);\r\n      }\r\n\r\n      if (event.exception?.values) {\r\n        event.exception.values = event.exception.values.map(exception => ({\r\n          ...exception,\r\n          value: sanitizePHI(exception.value || ''),\r\n        }));\r\n      }\r\n\r\n      return event;\r\n    },\r\n\r\n    // Additional configuration\r\n    integrations: [\r\n      Sentry.browserTracingIntegration({\r\n        tracePropagationTargets: ['localhost', /^https:\\/\\/.*\\.whitecross\\.com/],\r\n      }),\r\n      Sentry.replayIntegration({\r\n        maskAllText: true, // HIPAA compliance: mask all text\r\n        blockAllMedia: true, // HIPAA compliance: block all media\r\n      }),\r\n    ],\r\n\r\n    // Ignore common errors\r\n    ignoreErrors: [\r\n      'ResizeObserver loop limit exceeded',\r\n      'Non-Error promise rejection captured',\r\n      'Network request failed',\r\n      'Failed to fetch',\r\n      'Load failed',\r\n      'NetworkError',\r\n    ],\r\n\r\n    // Release tracking\r\n    release: process.env.NEXT_PUBLIC_SENTRY_RELEASE || process.env.VERCEL_GIT_COMMIT_SHA,\r\n  });\r\n\r\n  sentryInitialized = true;\r\n}\r\n\r\n/**\r\n * Sanitize PHI from error messages\r\n * Removes patient names, SSNs, DOBs, and other identifiable information\r\n */\r\nfunction sanitizePHI(text: string): string {\r\n  if (!text) return text;\r\n\r\n  return (\r\n    text\r\n      // Remove SSN patterns (XXX-XX-XXXX)\r\n      .replace(/\\b\\d{3}-\\d{2}-\\d{4}\\b/g, '[SSN-REDACTED]')\r\n      // Remove email addresses\r\n      .replace(/\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z|a-z]{2,}\\b/g, '[EMAIL-REDACTED]')\r\n      // Remove phone numbers\r\n      .replace(/\\b\\d{3}[-.]?\\d{3}[-.]?\\d{4}\\b/g, '[PHONE-REDACTED]')\r\n      // Remove dates that might be DOB (MM/DD/YYYY, MM-DD-YYYY)\r\n      .replace(/\\b\\d{1,2}[/-]\\d{1,2}[/-]\\d{4}\\b/g, '[DATE-REDACTED]')\r\n      // Remove potential medical record numbers (MRN)\r\n      .replace(/\\bMRN[:\\s]*\\d+\\b/gi, '[MRN-REDACTED]')\r\n      // Remove potential patient IDs\r\n      .replace(/\\bpatient[_\\s]?id[:\\s]*\\d+\\b/gi, '[PATIENT-ID-REDACTED]')\r\n  );\r\n}\r\n\r\n/**\r\n * Capture exception with context (Lazy Loaded)\r\n */\r\nexport async function captureException(\r\n  error: Error,\r\n  context?: {\r\n    tags?: Record<string, string>;\r\n    extra?: Record<string, unknown>;\r\n    level?: SentryTypes.SeverityLevel;\r\n  }\r\n) {\r\n  const Sentry = await loadSentry();\r\n  if (!Sentry) return;\r\n\r\n  if (context?.tags) {\r\n    Sentry.setTags(context.tags);\r\n  }\r\n\r\n  if (context?.extra) {\r\n    Sentry.setExtras(context.extra);\r\n  }\r\n\r\n  Sentry.captureException(error, {\r\n    level: context?.level || 'error',\r\n  });\r\n}\r\n\r\n/**\r\n * Capture message with context (Lazy Loaded)\r\n */\r\nexport async function captureMessage(\r\n  message: string,\r\n  context?: {\r\n    tags?: Record<string, string>;\r\n    extra?: Record<string, unknown>;\r\n    level?: SentryTypes.SeverityLevel;\r\n  }\r\n) {\r\n  const Sentry = await loadSentry();\r\n  if (!Sentry) return;\r\n\r\n  const sanitizedMessage = sanitizePHI(message);\r\n\r\n  if (context?.tags) {\r\n    Sentry.setTags(context.tags);\r\n  }\r\n\r\n  if (context?.extra) {\r\n    Sentry.setExtras(context.extra);\r\n  }\r\n\r\n  Sentry.captureMessage(sanitizedMessage, context?.level || 'info');\r\n}\r\n\r\n/**\r\n * Set user context (no PHI) (Lazy Loaded)\r\n */\r\nexport async function setUserContext(user: {\r\n  id: string;\r\n  role?: string;\r\n  organizationId?: string;\r\n}) {\r\n  const Sentry = await loadSentry();\r\n  if (!Sentry) return;\r\n\r\n  Sentry.setUser({\r\n    id: user.id,\r\n    // DO NOT include name, email, or other PHI\r\n    role: user.role,\r\n    organizationId: user.organizationId,\r\n  });\r\n}\r\n\r\n/**\r\n * Clear user context (Lazy Loaded)\r\n */\r\nexport async function clearUserContext() {\r\n  const Sentry = await loadSentry();\r\n  if (!Sentry) return;\r\n\r\n  Sentry.setUser(null);\r\n}\r\n\r\n/**\r\n * Start transaction for performance monitoring (Lazy Loaded)\r\n */\r\nexport async function startTransaction(\r\n  name: string,\r\n  operation: string,\r\n  data?: Record<string, unknown>\r\n) {\r\n  const Sentry = await loadSentry();\r\n  if (!Sentry) return undefined;\r\n\r\n  return Sentry.startTransaction({\r\n    name,\r\n    op: operation,\r\n    data,\r\n  });\r\n}\r\n\r\n/**\r\n * Add breadcrumb for debugging (Lazy Loaded)\r\n */\r\nexport async function addBreadcrumb(\r\n  message: string,\r\n  category?: string,\r\n  level?: SentryTypes.SeverityLevel,\r\n  data?: Record<string, unknown>\r\n) {\r\n  const Sentry = await loadSentry();\r\n  if (!Sentry) return;\r\n\r\n  const sanitizedMessage = sanitizePHI(message);\r\n\r\n  Sentry.addBreadcrumb({\r\n    message: sanitizedMessage,\r\n    category: category || 'custom',\r\n    level: level || 'info',\r\n    data,\r\n    timestamp: Date.now() / 1000,\r\n  });\r\n}\r\n\r\n/**\r\n * Wrap async function with error tracking (Lazy Loaded)\r\n */\r\nexport function withSentry<T extends (...args: any[]) => Promise<any>>(\r\n  fn: T,\r\n  functionName?: string\r\n): T {\r\n  return (async (...args: Parameters<T>) => {\r\n    try {\r\n      return await fn(...args);\r\n    } catch (error) {\r\n      await captureException(error as Error, {\r\n        tags: {\r\n          function: functionName || fn.name,\r\n        },\r\n      });\r\n      throw error;\r\n    }\r\n  }) as T;\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 211, "column": 0}, "map": {"version":3,"sources":["file:///F:/temp/white-cross/frontend/instrumentation.ts"],"sourcesContent":["/**\r\n * Next.js Server Instrumentation - White Cross Healthcare Platform\r\n *\r\n * This file implements Next.js instrumentation API for monitoring, error tracking,\r\n * and observability initialization. It runs once during server startup in both\r\n * Node.js and Edge runtime environments.\r\n *\r\n * Key Responsibilities:\r\n * - Initialize error tracking and monitoring (Sentry)\r\n * - Set up distributed tracing for healthcare workflows\r\n * - Configure performance monitoring for patient-critical operations\r\n * - Establish request-level error handling\r\n *\r\n * Healthcare Context:\r\n * - Error tracking is HIPAA-compliant (no PHI in error reports)\r\n * - Monitoring helps identify issues affecting patient care workflows\r\n * - Performance tracking ensures responsive healthcare operations\r\n * - Request error logging aids in security auditing\r\n *\r\n * Runtime Support:\r\n * - Node.js runtime: Full server-side instrumentation\r\n * - Edge runtime: Lightweight instrumentation for edge functions\r\n *\r\n * @module instrumentation\r\n * @see https://nextjs.org/docs/app/building-your-application/optimizing/instrumentation\r\n * @see https://docs.sentry.io/platforms/javascript/guides/nextjs/\r\n * @version 1.0.0\r\n * @since 2025-10-26\r\n */\r\n\r\nimport { initSentry } from './src/lib/monitoring/sentry';\r\n\r\n/**\r\n * Registers server instrumentation during Next.js server startup.\r\n *\r\n * This function is called automatically by Next.js when the server starts.\r\n * It initializes monitoring, tracing, and error tracking for the application.\r\n * Runs in both Node.js (full server) and Edge (serverless) runtime environments.\r\n *\r\n * Initialization Steps:\r\n * 1. Detect runtime environment (nodejs vs edge)\r\n * 2. Initialize Sentry error tracking\r\n * 3. Configure monitoring for healthcare-specific workflows\r\n * 4. Log successful initialization\r\n *\r\n * HIPAA Compliance:\r\n * - Sentry is configured to redact PHI from error reports\r\n * - No patient data is included in monitoring telemetry\r\n * - Error contexts are sanitized before transmission\r\n *\r\n * Performance Impact:\r\n * - Initialization runs once at startup (not per-request)\r\n * - Minimal overhead on healthcare application performance\r\n * - Async initialization doesn't block server startup\r\n *\r\n * @returns {void}\r\n *\r\n * @example\r\n * ```typescript\r\n * // Automatically called by Next.js during server startup\r\n * // No manual invocation required\r\n *\r\n * // Check logs for successful initialization:\r\n * // \"Server instrumentation initialized\"\r\n * ```\r\n *\r\n * @see https://nextjs.org/docs/app/api-reference/file-conventions/instrumentation\r\n */\r\nexport function register() {\r\n  if (process.env.NEXT_RUNTIME === 'nodejs') {\r\n    // Initialize Sentry for error tracking in Node.js runtime\r\n    // Handles errors in Server Components, API routes, and middleware\r\n    initSentry();\r\n\r\n    console.log('Server instrumentation initialized');\r\n  }\r\n\r\n  if (process.env.NEXT_RUNTIME === 'edge') {\r\n    // Initialize edge runtime instrumentation\r\n    // Lighter-weight monitoring for Edge Runtime and middleware\r\n    initSentry();\r\n\r\n    console.log('Edge runtime instrumentation initialized');\r\n  }\r\n}\r\n\r\n/**\r\n * Handles request-level errors for logging and monitoring.\r\n *\r\n * This optional handler is called automatically by Next.js when a request fails.\r\n * It provides centralized error logging and enables custom error handling logic\r\n * for healthcare-specific scenarios.\r\n *\r\n * Use Cases:\r\n * - Log critical errors affecting patient care workflows\r\n * - Track API failures for incident response\r\n * - Monitor authentication and authorization failures\r\n * - Audit security-related errors for HIPAA compliance\r\n *\r\n * Privacy & Security:\r\n * - Error logs must not include PHI (Protected Health Information)\r\n * - Request headers are logged but sanitized of sensitive data\r\n * - Error messages are sanitized before external transmission\r\n *\r\n * Integration Points:\r\n * - Sentry: Automatic error reporting\r\n * - DataDog: Request error metrics\r\n * - Internal logging: Audit trail for compliance\r\n *\r\n * @param {Error} error - The error that occurred during request processing\r\n * @param {object} request - Request context information\r\n * @param {string} request.path - The URL path where the error occurred\r\n * @param {string} request.method - HTTP method (GET, POST, etc.)\r\n * @param {Record<string, string>} request.headers - Request headers (sanitized)\r\n * @returns {Promise<void>}\r\n *\r\n * @example\r\n * ```typescript\r\n * // Automatically called by Next.js on request errors\r\n * // Example error log output:\r\n * // {\r\n * //   error: \"Database connection timeout\",\r\n * //   path: \"/api/students\",\r\n * //   method: \"GET\"\r\n * // }\r\n * ```\r\n *\r\n * @see https://nextjs.org/docs/app/api-reference/file-conventions/instrumentation#onrequesterror\r\n */\r\nexport async function onRequestError(\r\n  error: Error,\r\n  request: {\r\n    path: string;\r\n    method: string;\r\n    headers: Record<string, string>;\r\n  }\r\n) {\r\n  // Log error details for debugging and monitoring\r\n  // Note: Ensure no PHI is included in error messages\r\n  console.error('Request error:', {\r\n    error: error.message,\r\n    path: request.path,\r\n    method: request.method,\r\n    // Headers logged but Authorization tokens are automatically redacted by logger\r\n  });\r\n\r\n  // Additional error handling can be added here:\r\n  // - Send to external monitoring (DataDog, Sentry - already auto-captured)\r\n  // - Trigger alerts for critical healthcare operations\r\n  // - Record in audit log for compliance tracking\r\n  // - Custom retry logic for transient failures\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;CA4BC;;;;;;AAED;;AAsCO,SAAS;IACd,wCAA2C;QACzC,0DAA0D;QAC1D,kEAAkE;QAClE,IAAA,qJAAU;QAEV,QAAQ,GAAG,CAAC;IACd;IAEA;;AAOF;AA6CO,eAAe,eACpB,KAAY,EACZ,OAIC;IAED,iDAAiD;IACjD,oDAAoD;IACpD,QAAQ,KAAK,CAAC,kBAAkB;QAC9B,OAAO,MAAM,OAAO;QACpB,MAAM,QAAQ,IAAI;QAClB,QAAQ,QAAQ,MAAM;IAExB;AAEA,+CAA+C;AAC/C,0EAA0E;AAC1E,sDAAsD;AACtD,gDAAgD;AAChD,8CAA8C;AAChD","debugId":null}}]
}