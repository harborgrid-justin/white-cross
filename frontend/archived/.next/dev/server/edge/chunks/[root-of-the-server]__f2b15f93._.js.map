{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/middleware.ts"],"sourcesContent":["/**\r\n * Next.js Middleware - Authentication, Security & Rate Limiting\r\n *\r\n * CRITICAL SECURITY: This middleware enforces authentication and HIPAA compliance.\r\n * All PHI routes require valid authentication tokens and role-based access.\r\n *\r\n * @module middleware\r\n * @since 2025-11-05\r\n */\r\n\r\nimport { NextRequest, NextResponse } from 'next/server';\r\n\r\n// Cookie configuration\r\nconst COOKIE_NAMES = {\r\n  ACCESS_TOKEN: process.env.NODE_ENV === 'production' ? '__Host-auth.token' : 'auth.token',\r\n};\r\n\r\n// Stub for rate limiter - will be implemented later\r\nfunction getRateLimiter() {\r\n  return {\r\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n    check: async (_identifier: string, _limit: number, _window: string) => ({\r\n      success: true,\r\n      retryAfter: null,\r\n    }),\r\n  };\r\n}\r\n\r\n/**\r\n * Public routes that don't require authentication\r\n */\r\nconst PUBLIC_ROUTES = [\r\n  '/login',\r\n  '/session-expired',\r\n  '/forgot-password',\r\n  '/reset-password',\r\n  '/_next',\r\n  '/favicon.ico',\r\n  '/api/health',\r\n  '/api/auth/login',\r\n  '/api/auth/refresh',\r\n  '/api/auth/logout',\r\n];\r\n\r\n/**\r\n * PHI routes requiring enhanced security and audit logging\r\n */\r\nconst PHI_ROUTES = [\r\n  '/students',\r\n  '/health-records',\r\n  '/medications',\r\n  '/incidents',\r\n  '/communications',\r\n  '/api/v1/students',\r\n  '/api/v1/health-records',\r\n  '/api/v1/medications',\r\n];\r\n\r\n/**\r\n * Admin routes requiring ADMIN or SYSTEM_ADMIN role\r\n */\r\nconst ADMIN_ROUTES = [\r\n  '/admin',\r\n  '/api/v1/admin',\r\n];\r\n\r\n/**\r\n * Main middleware function\r\n */\r\nexport default async function middleware(request: NextRequest) {\r\n  const { pathname } = request.nextUrl;\r\n\r\n  // Fix for GitHub Codespaces Server Actions\r\n  // Server Actions validate origin against x-forwarded-host\r\n  const isCodespaces = process.env.CODESPACES === 'true' || \r\n                       request.headers.get('x-forwarded-host')?.includes('.app.github.dev');\r\n  \r\n  if (isCodespaces) {\r\n    const response = NextResponse.next();\r\n    const forwardedHost = request.headers.get('x-forwarded-host');\r\n    \r\n    // Override origin to match forwarded host for Server Actions\r\n    if (forwardedHost) {\r\n      response.headers.set('x-forwarded-host', forwardedHost);\r\n      response.headers.set('x-forwarded-proto', 'https');\r\n    }\r\n    \r\n    // For Server Actions POST requests, we need to rewrite headers\r\n    if (request.method === 'POST' && request.headers.get('content-type')?.includes('multipart/form-data')) {\r\n      return response;\r\n    }\r\n  }\r\n\r\n  // Allow public routes\r\n  if (PUBLIC_ROUTES.some(route => pathname.startsWith(route))) {\r\n    return NextResponse.next();\r\n  }\r\n\r\n  // Rate limiting for API routes\r\n  if (pathname.startsWith('/api/')) {\r\n    const rateLimitResult = await checkRateLimit(request);\r\n    if (!rateLimitResult.success) {\r\n      return new NextResponse('Too Many Requests', {\r\n        status: 429,\r\n        headers: {\r\n          'Retry-After': rateLimitResult.retryAfter || '60',\r\n        },\r\n      });\r\n    }\r\n  }\r\n\r\n  // Authentication check\r\n  const authResult = await authenticateRequest(request);\r\n\r\n  if (!authResult.authenticated) {\r\n    // Redirect to login with return URL\r\n    const loginUrl = new URL('/login', request.url);\r\n    loginUrl.searchParams.set('returnUrl', pathname);\r\n    return NextResponse.redirect(loginUrl);\r\n  }\r\n\r\n  // Role-based access control for admin routes\r\n  if (ADMIN_ROUTES.some(route => pathname.startsWith(route))) {\r\n    if (!['ADMIN', 'SYSTEM_ADMIN'].includes(authResult.user?.role || '')) {\r\n      return new NextResponse('Forbidden', { status: 403 });\r\n    }\r\n  }\r\n\r\n  // PHI access audit logging\r\n  if (PHI_ROUTES.some(route => pathname.startsWith(route))) {\r\n    // Note: Actual audit logging should happen in Server Actions/API routes\r\n    // Here we just add headers for downstream processing\r\n    const response = NextResponse.next();\r\n    response.headers.set('X-PHI-Access', 'true');\r\n    response.headers.set('X-User-Id', authResult.user?.id || '');\r\n    response.headers.set('X-User-Role', authResult.user?.role || '');\r\n    return response;\r\n  }\r\n\r\n  // Add user context to request headers\r\n  const response = NextResponse.next();\r\n  if (authResult.user) {\r\n    response.headers.set('X-User-Id', authResult.user.id);\r\n    response.headers.set('X-User-Email', authResult.user.email);\r\n    response.headers.set('X-User-Role', authResult.user.role);\r\n  }\r\n\r\n  return response;\r\n}\r\n\r\n/**\r\n * Authenticate request using JWT token from cookies\r\n * Note: This is a lightweight check in middleware. Full JWT verification\r\n * happens in API routes and server actions.\r\n */\r\nasync function authenticateRequest(request: NextRequest) {\r\n  try {\r\n    const token = request.cookies.get(COOKIE_NAMES.ACCESS_TOKEN)?.value;\r\n\r\n    if (!token || token.length < 20) {\r\n      return { authenticated: false };\r\n    }\r\n\r\n    // Basic token format validation (JWT has 3 parts separated by dots)\r\n    const parts = token.split('.');\r\n    if (parts.length !== 3) {\r\n      return { authenticated: false };\r\n    }\r\n\r\n    // For middleware, we assume the token is valid if it exists and has proper format\r\n    // Full verification happens in API routes\r\n    return {\r\n      authenticated: true,\r\n      user: {\r\n        id: 'middleware-user', // Placeholder - actual user data comes from API routes\r\n        email: 'middleware@example.com',\r\n        role: 'USER',\r\n      },\r\n    };\r\n  } catch (error) {\r\n    console.error('[Middleware] Authentication failed:', error);\r\n    return { authenticated: false };\r\n  }\r\n}\r\n\r\n/**\r\n * Rate limiting check\r\n */\r\nasync function checkRateLimit(request: NextRequest) {\r\n  const { pathname } = request.nextUrl;\r\n  const limiter = getRateLimiter();\r\n\r\n  // Different limits for different routes\r\n  const limits = {\r\n    '/api/v1/health-records': { limit: 100, window: '15m' },\r\n    '/api/v1/students': { limit: 100, window: '15m' },\r\n    '/api/v1/medications': { limit: 100, window: '15m' },\r\n    '/api/v1': { limit: 500, window: '15m' },\r\n    default: { limit: 1000, window: '15m' },\r\n  };\r\n\r\n  const identifier = request.headers.get('x-forwarded-for') || request.headers.get('x-real-ip') || 'unknown';\r\n\r\n  // Find matching limit\r\n  let limit = limits.default;\r\n  for (const [route, routeLimit] of Object.entries(limits)) {\r\n    if (route !== 'default' && pathname.startsWith(route)) {\r\n      limit = routeLimit;\r\n      break;\r\n    }\r\n  }\r\n\r\n  return await limiter.check(identifier, limit.limit, limit.window);\r\n}\r\n\r\n/**\r\n * Middleware configuration\r\n */\r\nexport const config = {\r\n  matcher: [\r\n    /*\r\n     * Match all request paths except:\r\n     * - _next/static (static files)\r\n     * - _next/image (image optimization)\r\n     * - favicon.ico (favicon file)\r\n     */\r\n    '/((?!_next/static|_next/image|favicon.ico).*)',\r\n  ],\r\n};\r\n"],"names":[],"mappings":"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"}}]
}